name: Checks

on:
  pull_request:
    branches: "*"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: blacksmith-8vcpu-ubuntu-2404
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Setup Anchor
        uses: ./.github/actions/anchor
      - name: Install dependencies
        run: yarn install
      - name: Build packages
        run: yarn build --output-style static

  test:
    runs-on: blacksmith-8vcpu-ubuntu-2404
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Add swap to increase memory
        run: |
          set -euxo pipefail

          # Remove any existing/busy swapfile first
          if [ -f /swapfile ]; then
            sudo swapoff /swapfile || true
            sudo rm -f /swapfile
          fi

          # Try fallocate; fall back to dd if fallocate is unsupported or fails (e.g., Text file busy)
          if ! sudo fallocate -l 16G /swapfile 2>/dev/null; then
            sudo dd if=/dev/zero of=/swapfile bs=1M count=16384 status=none
          fi

          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h
      - name: Remove Unnecessary Files
        uses: ./.github/actions/cleanup
      - name: Setup Anchor
        uses: ./.github/actions/anchor
      - name: Install dependencies
        run: yarn install
      - name: Build common SDK
        run: yarn workspace @orca-so/common-sdk build
      - name: Build Whirlpool program (IDL)
        run: yarn workspace @orca-so/whirlpools-program build
      - name: Build legacy SDK only
        env:
          NODE_OPTIONS: --max-old-space-size=8192
        run: yarn workspace @orca-so/whirlpools-sdk build
      - name: Run LiteSVM-safe tests
        env:
          NODE_OPTIONS: --max-old-space-size=8192
          VITEST_SEGFAULT_RETRY: "2"
        run: |
          yarn vitest run legacy-sdk/whirlpool \
            --config legacy-sdk/whirlpool/vitest.config.mts \
            --reporter verbose
      - name: Run remaining Nx tests
        run: |
          yarn nx run-many \
            --target=test \
            --all \
            --exclude=whirlpools-sdk \
            --exclude=legacy-sdk/integration \
            --exclude=rust-sdk/integration

  lint:
    runs-on: blacksmith-8vcpu-ubuntu-2404
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Remove Unnecessary Files
        uses: ./.github/actions/cleanup
      - name: Setup Anchor
        uses: ./.github/actions/anchor
      - name: Install dependencies
        run: yarn install
      - name: Run Lint
        run: yarn lint --output-style static

  verify-generated:
    runs-on: blacksmith-8vcpu-ubuntu-2404
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Setup Anchor
        uses: ./.github/actions/anchor
      - name: Install dependencies
        run: yarn install
      - name: Generate clients
        run: yarn generate
      - name: Verify no diffs
        run: |
          git diff --exit-code -- \
            ts-sdk/client/src/generated \
            rust-sdk/client/src/generated

  changeset:
    runs-on: blacksmith-8vcpu-ubuntu-2404
    if: ${{ github.event.pull_request.user.login != 'dependabot[bot]' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Install dependencies
        run: yarn install
      - name: Check changesets
        run: yarn changeset status --since origin/main
