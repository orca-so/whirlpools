name: Checks

on:
  pull_request:
    branches: "*"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-program:
    runs-on: blacksmith-8vcpu-ubuntu-2404
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Build Solana program
        run: docker compose --profile build-program up
      - name: Upload Solana program artifacts
        uses: actions/upload-artifact@v4
        with:
          name: solana-programs-${{ github.run_id }}
          path: |
            target/deploy/*.so
            target/idl/*.json
            target/types/*.ts
          retention-days: 1

  build:
    runs-on: blacksmith-8vcpu-ubuntu-2404
    needs: build-program
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Download Solana program artifacts
        uses: actions/download-artifact@v4
        with:
          name: solana-programs-${{ github.run_id }}
          path: target
      - name: Clean stale volumes
        run: |
          docker volume rm -f whirlpools_node_modules || true
          docker volume rm -f whirlpools_yarn_cache || true
      - name: Build non-program packages
        run: docker compose --profile build up --quiet-pull --abort-on-container-failure

  test:
    runs-on: blacksmith-8vcpu-ubuntu-2404
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Download Solana program artifacts
        uses: actions/download-artifact@v4
        with:
          name: solana-programs-${{ github.run_id }}
          path: target
      - name: Clean stale volumes
        run: |
          docker volume rm -f whirlpools_node_modules || true
          docker volume rm -f whirlpools_yarn_cache || true
      - name: Run tests
        run: docker compose --profile test up --quiet-pull --abort-on-container-failure

  test-whirlpools-program:
    runs-on: blacksmith-8vcpu-ubuntu-2404-arm
    needs: build-program
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Download Solana program artifacts
        uses: actions/download-artifact@v4
        with:
          name: solana-programs-${{ github.run_id }}
          path: target
      - name: Clean stale volumes
        run: |
          docker volume rm -f whirlpools_node_modules || true
          docker volume rm -f whirlpools_yarn_cache || true
      - name: Run tests
        run: docker compose --profile test-whirlpools-program up --quiet-pull --abort-on-container-failure

  lint:
    runs-on: blacksmith-8vcpu-ubuntu-2404
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Run lint
        run: docker compose --profile lint up --quiet-pull --abort-on-container-failure

  verify-generated:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Setup Anchor
        uses: ./.github/actions/anchor
      - name: Install dependencies
        run: yarn install
      - name: Generate clients
        run: yarn generate
      - name: Verify no diffs
        run: |
          git diff --exit-code -- \
            ts-sdk/client/src/generated \
            rust-sdk/client/src/generated

  changeset:
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request.user.login != 'dependabot[bot]' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Install dependencies
        run: yarn install
      - name: Check changesets
        run: yarn changeset status --since origin/main
