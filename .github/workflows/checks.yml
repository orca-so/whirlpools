name: Checks

on:
  pull_request:
    branches: "*"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: blacksmith-8vcpu-ubuntu-2404
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build all packages
        run: docker compose --profile build up --quiet-pull --abort-on-container-failure

  test:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Install Docker
        run: |
          brew install docker docker-compose colima qemu
          # Start colima with qemu driver (more compatible with CI)
          colima start --cpu 4 --memory 8 --disk 50 --vm-type=qemu --mount-type=sshfs
          # Wait for Docker to be ready
          for i in {1..60}; do
            docker info &>/dev/null && break
            echo "Waiting for Docker to be ready..."
            sleep 2
          done
          docker info
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Run all tests
        run: docker compose --profile test up --quiet-pull --abort-on-container-failure

  lint:
    runs-on: blacksmith-8vcpu-ubuntu-2404
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Run lint
        run: docker compose --profile lint up --quiet-pull --abort-on-container-failure

  verify-generated:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Setup Anchor
        uses: ./.github/actions/anchor
      - name: Install dependencies
        run: yarn install
      - name: Generate clients
        run: yarn generate
      - name: Verify no diffs
        run: |
          git diff --exit-code -- \
            ts-sdk/client/src/generated \
            rust-sdk/client/src/generated

  changeset:
    runs-on: ubuntu-latest
    if: ${{ !(github.event.pull_request.user.login == 'dependabot[bot]' || contains(github.event.pull_request.labels.*.name, 'skip-changeset')) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Install dependencies
        run: yarn install
      - name: Check changesets
        run: yarn changeset status --since origin/main
