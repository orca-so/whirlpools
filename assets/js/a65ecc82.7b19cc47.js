"use strict";(self.webpackChunk_orca_so_whirlpools_docs=self.webpackChunk_orca_so_whirlpools_docs||[]).push([[356],{1132:(e,i,t)=>{t.d(i,{A:()=>r});const r=t.p+"assets/images/sparseswap-2-ca9617294db256b7c3fb97996020e83d.png"},1184:(e,i,t)=>{t.d(i,{R:()=>a,x:()=>c});var r=t(4041);const s={},n=r.createContext(s);function a(e){const i=r.useContext(n);return r.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function c(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(n.Provider,{value:i},e.children)}},1778:(e,i,t)=>{t.d(i,{A:()=>r});const r=t.p+"assets/images/tickarray-overview-fae96d88215fe3a6e36a3175b17668ac.png"},1815:(e,i,t)=>{t.d(i,{A:()=>r});const r=t.p+"assets/images/sparseswap-1-d3e4f774398d6dbe40593201787e63bb.png"},2293:(e,i,t)=>{t.r(i),t.d(i,{assets:()=>o,contentTitle:()=>c,default:()=>d,frontMatter:()=>a,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"Architecture Overview/Understanding Tick Arrays","title":"Understanding Tick Arrays","description":"TickArray Account Architecture","source":"@site/docs/02-Architecture Overview/03-Understanding Tick Arrays.md","sourceDirName":"02-Architecture Overview","slug":"/Architecture Overview/Understanding Tick Arrays","permalink":"/Architecture Overview/Understanding Tick Arrays","draft":false,"unlisted":false,"editUrl":"https://github.com/orca-so/whirlpools/tree/main/docs/whirlpool/docs/02-Architecture Overview/03-Understanding Tick Arrays.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{},"sidebar":"sidebar","previous":{"title":"Price & Ticks","permalink":"/Architecture Overview/Price & Ticks"},"next":{"title":"Tokenized Positions","permalink":"/Architecture Overview/Tokenized Positions"}}');var s=t(1085),n=t(1184);const a={},c="Understanding Tick Arrays",o={},l=[{value:"Usage in Whirlpool Program Instructions",id:"usage-in-whirlpool-program-instructions",level:2},{value:"Open Position",id:"open-position",level:3},{value:"Adjust Liquidity (increase / decrease liquidity)",id:"adjust-liquidity-increase--decrease-liquidity",level:3},{value:"Swap",id:"swap",level:3},{value:"Supply additional tick arrays with <code>swapV2</code>",id:"supply-additional-tick-arrays-with-swapv2",level:4},{value:"SparseSwap: crossing unitialized tick arrays during swap",id:"sparseswap-crossing-unitialized-tick-arrays-during-swap",level:4},{value:"SparseSwap: generating quotes",id:"sparseswap-generating-quotes",level:4}];function h(e){const i={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",img:"img",li:"li",p:"p",strong:"strong",ul:"ul",...(0,n.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(i.header,{children:(0,s.jsx)(i.h1,{id:"understanding-tick-arrays",children:"Understanding Tick Arrays"})}),"\n",(0,s.jsx)(i.p,{children:(0,s.jsx)(i.img,{alt:"TickArray Account Architecture",src:t(1778).A+"",width:"800",height:"508"})}),"\n",(0,s.jsxs)(i.p,{children:["A sequence of ticks are stored in individual ",(0,s.jsx)(i.strong,{children:"tick-array"})," accounts on chain. Each whirlpool has a sequence of tick-array accounts to host the entire tick range."]}),"\n",(0,s.jsx)(i.p,{children:"A tick-array is keyed by the start-index of its hosted ticks and can hold 88 physical ticks in an array. It only hosts the tick objects for the initializable tick indices based on the Whirlpool's tick-spacing. The total range for a tick-array is therefore 88 * tick-spacing."}),"\n",(0,s.jsx)(i.p,{children:(0,s.jsx)(i.strong,{children:"Tick Array Account Info"})}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:"Number of physical tick slots - 88"}),"\n",(0,s.jsx)(i.li,{children:"Account Size - 10kb"}),"\n"]}),"\n",(0,s.jsx)(i.h2,{id:"usage-in-whirlpool-program-instructions",children:"Usage in Whirlpool Program Instructions"}),"\n",(0,s.jsx)(i.p,{children:"When you interact with ticks on Whirlpool instructions, often you will need to derive the correct tick-array so the program can get access to the designated tick object. This tick-array is a PDA derived using the Whirlpool pool\u2019s public key and the start tick index of the tick array, which defines the beginning of a specific range of ticks."}),"\n",(0,s.jsx)(i.p,{children:"For example, if the current tick is 200, the tick spacing is 2, and each tick-array contains 88 ticks, you can compute the start tick index by first finding the closest multiple of tick_spacing * ticks_per_array that is less than or equal to the current tick. Here, the start tick index would be 176, calculated as (200 // (2 * 88)) * (2 * 88)."}),"\n",(0,s.jsx)(i.h3,{id:"open-position",children:"Open Position"}),"\n",(0,s.jsx)(i.p,{children:"When a position opens up in a new tick or price range, the tick-array must be initialized before the position can be created. This means the user invoking the position will need to cover the rent-exempt cost for the tick-array account, which is 10 KB in size."}),"\n",(0,s.jsx)(i.p,{children:"Once a tick-array account is set up, it cannot be closed and will never need to be reinitialized. For this reason, Whirlpool owners may consider preemptively initializing tick-array ranges to prevent unexpected costs for users."}),"\n",(0,s.jsx)(i.h3,{id:"adjust-liquidity-increase--decrease-liquidity",children:"Adjust Liquidity (increase / decrease liquidity)"}),"\n",(0,s.jsx)(i.p,{children:"Users of these instructions must provide the tick-arrays that contain the specified tick indexes. For each instruction, two tick-arrays need to be passed in\u2014these may be the same array if the range is small. The instruction requires access to these accounts to read the appropriate Tick objects effectively."}),"\n",(0,s.jsx)(i.h3,{id:"swap",children:"Swap"}),"\n",(0,s.jsx)(i.p,{children:"Swap users must specify a series of tick arrays across which the swap will traverse."}),"\n",(0,s.jsx)(i.p,{children:"The first tick array in the sequence typically contains the Whirlpool\u2019s current tick index, though this is not strictly required. Before processing the swap, the Whirlpool program will order the tick arrays automatically."}),"\n",(0,s.jsx)(i.p,{children:"The second and third tick arrays are those immediately following in the swap direction. If the user knows the swap will not move into the next tick array, or if it's not possible at either end of the price range, they can provide any tick array public key instead."}),"\n",(0,s.jsxs)(i.h4,{id:"supply-additional-tick-arrays-with-swapv2",children:["Supply additional tick arrays with ",(0,s.jsx)(i.code,{children:"swapV2"})]}),"\n",(0,s.jsxs)(i.p,{children:["With the new ",(0,s.jsx)(i.code,{children:"swapV2"})," instruction, users can include an additional three tick arrays in the ",(0,s.jsx)(i.code,{children:"remaining_accounts"})," field of the instruction data. This allows up to six tick arrays to be submitted in total for ",(0,s.jsx)(i.code,{children:"swapV2"}),"."]}),"\n",(0,s.jsxs)(i.p,{children:["This feature is particularly useful if the current tick is near the edge of the tick array during quote generation but then moves outside of it by the time the transaction executes (see the diagram below). To avoid errors in such scenarios, users can pass the tick array account with a start index of -88 in the ",(0,s.jsx)(i.code,{children:"remaining_accounts"})," field."]}),"\n",(0,s.jsxs)(i.p,{children:["If you're using the Typescript Whirlpools SDK ",(0,s.jsx)(i.a,{href:"https://www.npmjs.com/package/@orca-so/whirlpools",children:(0,s.jsx)(i.code,{children:"@orca-so/whirlpools"})})," or the Rust Whirlpools SDK ",(0,s.jsx)(i.a,{href:"https://crates.io/crates/orca_whirlpools",children:(0,s.jsx)(i.code,{children:"orca_whirlpools"})})," to generate the swap instructions, this is automatically handled."]}),"\n",(0,s.jsxs)(i.blockquote,{children:["\n",(0,s.jsx)(i.p,{children:"NOTE: even though you can submit up to 6 tick arrays to the swap instruction, the program will consider only up to three tick arrays for the swap. If the price moves beyond the third tick array, the program will throw an error and the swap will not go through."}),"\n"]}),"\n",(0,s.jsx)(i.p,{children:(0,s.jsx)(i.img,{alt:"Sparse Swap Overview 1",src:t(1815).A+"",width:"1358",height:"678"})}),"\n",(0,s.jsx)(i.h4,{id:"sparseswap-crossing-unitialized-tick-arrays-during-swap",children:"SparseSwap: crossing unitialized tick arrays during swap"}),"\n",(0,s.jsxs)(i.p,{children:["For both the ",(0,s.jsx)(i.code,{children:"swap"})," and ",(0,s.jsx)(i.code,{children:"swapV2"})," instructions, it is not necessary for all tick array accounts to be initialized. As long as there is sufficient active liquidity at the current tick (a property defined in the Whirlpool state), the Whirlpool program can execute a swap. The diagram below illustrates this."]}),"\n",(0,s.jsx)(i.p,{children:(0,s.jsx)(i.img,{alt:"Sparse Swap Overview 2",src:t(1132).A+"",width:"1358",height:"678"})}),"\n",(0,s.jsx)(i.h4,{id:"sparseswap-generating-quotes",children:"SparseSwap: generating quotes"}),"\n",(0,s.jsx)(i.p,{children:"Our SDKs account for the possibility of uninitialized tick arrays and can reliably generate valid swap quotes. We highly encourage you to use one of our official SDKs:"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:"TS Whirlpools SDK"}),"\n",(0,s.jsx)(i.li,{children:"Rust Whirlpools SDK"}),"\n",(0,s.jsx)(i.li,{children:"TS Legacy SDK (version > 0.13.4)"}),"\n"]}),"\n",(0,s.jsx)(i.p,{children:"If you are building custom integrations, be aware of this feature. To generate a quote, you must fetch the tick array accounts and parse the ticks to identify any liquidity changes that may occur during the swap. If you encounter an uninitialized tick array, you might incorrectly assume there is no remaining liquidity and erroneously inform users that swapping is not possible. To avoid this, review our SDK internals on quote generation, particularly these functions:"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:(0,s.jsx)(i.a,{href:"https://github.com/orca-so/whirlpools/blob/4c75c2f0bbc9fa8ad850a49ddf2ed37e527901f8/rust-sdk/whirlpool/src/swap.rs#L70-L112",children:(0,s.jsx)(i.code,{children:"fetch_tick_arrays_or_default"})})}),"\n",(0,s.jsx)(i.li,{children:(0,s.jsxs)(i.a,{href:"https://github.com/orca-so/whirlpools/blob/4c75c2f0bbc9fa8ad850a49ddf2ed37e527901f8/rust-sdk/core/src/quote/swap.rs#L29-L149",children:[(0,s.jsx)(i.code,{children:"swap_quote_by_input_token"})," and ",(0,s.jsx)(i.code,{children:"swap_quote_by_output_token"})]})}),"\n",(0,s.jsx)(i.li,{children:(0,s.jsx)(i.a,{href:"https://github.com/orca-so/whirlpools/blob/4c75c2f0bbc9fa8ad850a49ddf2ed37e527901f8/rust-sdk/core/src/quote/swap.rs#L178-L295",children:(0,s.jsx)(i.code,{children:"compute_swap"})})}),"\n",(0,s.jsx)(i.li,{children:(0,s.jsx)(i.a,{href:"https://github.com/orca-so/whirlpools/blob/4c75c2f0bbc9fa8ad850a49ddf2ed37e527901f8/rust-sdk/core/src/quote/swap.rs#L326-L412",children:(0,s.jsx)(i.code,{children:"compute_swap_step"})})}),"\n"]})]})}function d(e={}){const{wrapper:i}={...(0,n.R)(),...e.components};return i?(0,s.jsx)(i,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}}}]);