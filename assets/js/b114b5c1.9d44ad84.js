"use strict";(self.webpackChunk_orca_so_whirlpools_docs=self.webpackChunk_orca_so_whirlpools_docs||[]).push([[524],{1184:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>l});var s=i(4041);const t={},r=s.createContext(t);function o(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),s.createElement(r.Provider,{value:n},e.children)}},2223:(e,n,i)=>{i.d(n,{A:()=>s});const s=i.p+"assets/images/token-badge-74d090e9f547aab50adb71cd79657427.png"},5830:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"Architecture Overview/TokenExtensions Support","title":"TokenExtensions","description":"On May 28th 2024, Whirlpool program has been upgraded to support TokenExtensions (aka Token-2022 program).","source":"@site/docs/02-Architecture Overview/07-TokenExtensions Support.md","sourceDirName":"02-Architecture Overview","slug":"/Architecture Overview/TokenExtensions Support","permalink":"/Architecture Overview/TokenExtensions Support","draft":false,"unlisted":false,"editUrl":"https://github.com/orca-so/whirlpools/tree/main/docs/whirlpool/docs/02-Architecture Overview/07-TokenExtensions Support.md","tags":[],"version":"current","sidebarPosition":7,"frontMatter":{},"sidebar":"sidebar","previous":{"title":"Whirlpools Parameters","permalink":"/Architecture Overview/Whirlpool Parameters"},"next":{"title":"Overview","permalink":"/SDKs/Overview"}}');var t=i(1085),r=i(1184);const o={},l="TokenExtensions",d={},a=[{value:"Extension List",id:"extension-list",level:2},{value:"New Instructions",id:"new-instructions",level:2},{value:"V2 Instructions",id:"v2-instructions",level:3},{value:"For Trade",id:"for-trade",level:4},{value:"For Liquidity",id:"for-liquidity",level:4},{value:"For Fees and Rewards",id:"for-fees-and-rewards",level:4},{value:"For Pool",id:"for-pool",level:4},{value:"ConfigExtension &amp; TokenBadge Instructions",id:"configextension--tokenbadge-instructions",level:3},{value:"Token Badge",id:"token-badge",level:2},{value:"Notes",id:"notes",level:2},{value:"Freeze Authority",id:"freeze-authority",level:3},{value:"Native Token (WSOL)",id:"native-token-wsol",level:3},{value:"TransferFee",id:"transferfee",level:3},{value:"<code>amount</code> and <code>otherAmountThreshold</code>",id:"amount-and-otheramountthreshold",level:4},{value:"<code>minA/B</code>, <code>maxA/B</code>",id:"minab-maxab",level:4},{value:"TransferHook",id:"transferhook",level:3},{value:"Use of remaining_accounts",id:"use-of-remaining_accounts",level:4},{value:"Security notes",id:"security-notes",level:4},{value:"TokenBadge request",id:"tokenbadge-request",level:4}];function c(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",img:"img",li:"li",p:"p",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"tokenextensions",children:"TokenExtensions"})}),"\n",(0,t.jsx)(n.p,{children:"On May 28th 2024, Whirlpool program has been upgraded to support TokenExtensions (aka Token-2022 program)."}),"\n",(0,t.jsx)(n.h2,{id:"extension-list",children:"Extension List"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Supported"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"TransferFee"}),"\n",(0,t.jsx)(n.li,{children:"InterestBearing (supported since Oct 11th 2024)"}),"\n",(0,t.jsx)(n.li,{children:"MemoTransfer"}),"\n",(0,t.jsx)(n.li,{children:"MetadataPointer"}),"\n",(0,t.jsx)(n.li,{children:"TokenMetadata"}),"\n",(0,t.jsx)(n.li,{children:"ConfidentialTransfer (non-confidential transfer only)"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Supported if it has initialized TokenBadge"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"PermanentDelegate"}),"\n",(0,t.jsx)(n.li,{children:"TransferHook"}),"\n",(0,t.jsx)(n.li,{children:"MintCloseAuthority"}),"\n",(0,t.jsx)(n.li,{children:"DefaultAccountState (default state must be Initialized)"}),"\n"]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"\u2139\ufe0f FreezeAuthority is not extensions, but it requires TokenBadge.\nIt should be disabled unless there is a reasonable reason (e.g., legal compliance). FreezeAuthority rejection does not apply to TokenProgram tokens, but does apply to TokenExtensions tokens."}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Not Supported"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Group, GroupPointer"}),"\n",(0,t.jsx)(n.li,{children:"Member, MemberPointer"}),"\n",(0,t.jsx)(n.li,{children:"NonTransferable"}),"\n",(0,t.jsx)(n.li,{children:"All other extensions not listed above"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"new-instructions",children:"New Instructions"}),"\n",(0,t.jsx)(n.h3,{id:"v2-instructions",children:"V2 Instructions"}),"\n",(0,t.jsx)(n.p,{children:"V2 instructions have been added to handle tokens owned by Token-2022 program."}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"V1 instructions don\u2019t work for pools with Token-2022 tokens."}),"\n",(0,t.jsxs)(n.li,{children:["V2 instructions work for pools with the following combinations. So V2 encompasses V1; an implementation that always uses V2 is simple, but the downside is increased transaction size if ALT is not used because of the larger number of accounts required.","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Token / Token"}),"\n",(0,t.jsx)(n.li,{children:"Token-2022 / Token"}),"\n",(0,t.jsx)(n.li,{children:"Token / Token-2022"}),"\n",(0,t.jsx)(n.li,{children:"Token-2022 / Token-2022"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:"Token-2022 program requires Mint account for transfer, so the V2 instructions receive token programs and Mint accounts. It must also receive an SPL Memo program to support MemoTransfer."}),"\n",(0,t.jsx)(n.li,{children:"When dealing with tokens that have TransferHook extension, instructions will receive the accounts used by the hook program as remaining accounts."}),"\n",(0,t.jsx)(n.li,{children:"To reduce transfer fee, two_hop_swap_v2 transfers token directly from the first pool to the second pool. The user's token account is not passed through."}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"for-trade",children:"For Trade"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Instruction"}),(0,t.jsx)(n.th,{children:"Corresponding V1"}),(0,t.jsx)(n.th,{children:"Notes"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"swap_v2"}),(0,t.jsx)(n.td,{children:"swap"}),(0,t.jsx)(n.td,{})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"two_hop_swap_v2"}),(0,t.jsx)(n.td,{children:"two_hop_swap"}),(0,t.jsx)(n.td,{children:"intermediate token accounts have been eliminated to reduce transfer fee overhead"})]})]})]}),"\n",(0,t.jsx)(n.h4,{id:"for-liquidity",children:"For Liquidity"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Instruction"}),(0,t.jsx)(n.th,{children:"Corresponding V1"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"increase_liquidity_v2"}),(0,t.jsx)(n.td,{children:"increase_liquidity"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"decrease_liquidity_v2"}),(0,t.jsx)(n.td,{children:"decrease_liquidity"})]})]})]}),"\n",(0,t.jsx)(n.h4,{id:"for-fees-and-rewards",children:"For Fees and Rewards"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Instruction"}),(0,t.jsx)(n.th,{children:"Corresponding V1"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"collect_fees_v2"}),(0,t.jsx)(n.td,{children:"collect_fees"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"collect_reward_v2"}),(0,t.jsx)(n.td,{children:"collect_reward"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"collect_protocol_fees_v2"}),(0,t.jsx)(n.td,{children:"collect_protocol_fees"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"set_reward_emissions_v2"}),(0,t.jsx)(n.td,{children:"set_reward_emissions"})]})]})]}),"\n",(0,t.jsx)(n.h4,{id:"for-pool",children:"For Pool"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Instruction"}),(0,t.jsx)(n.th,{children:"Corresponding V1"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"initialize_pool_v2"}),(0,t.jsx)(n.td,{children:"initialize_pool"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"initialize_reward_v2"}),(0,t.jsx)(n.td,{children:"initialize_reward"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"configextension--tokenbadge-instructions",children:"ConfigExtension & TokenBadge Instructions"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"initialize_config_extension"}),"\n",(0,t.jsx)(n.li,{children:"set_config_extension_authority"}),"\n",(0,t.jsx)(n.li,{children:"set_token_badge_authority"}),"\n",(0,t.jsx)(n.li,{children:"initialize_token_badge"}),"\n",(0,t.jsx)(n.li,{children:"delete_token_badge"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"token-badge",children:"Token Badge"}),"\n",(0,t.jsx)(n.p,{children:"Allowing unrestricted pool creation with tokens that have certain extensions, like PermanentDelegate, was found to pose more risks than benefits. To safely support these types of tokens, the TokenBadge was introduced as a whitelist mechanism."}),"\n",(0,t.jsx)(n.p,{children:"A TokenBadge is a PDA which allows pools and rewards to be initialized for such tokens. Each wirlpool config can independently whitelist tokens using a TokenBadge account"}),"\n",(0,t.jsx)(n.p,{children:"The TokenBadge itself only records the WhirlpoolsConfig and Mint used at initialization, without any additional information. Its existence signifies that pools and rewards can be initialized for the associated token."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"TokenBadge",src:i(2223).A+"",width:"800",height:"508"})}),"\n",(0,t.jsx)(n.h2,{id:"notes",children:"Notes"}),"\n",(0,t.jsx)(n.h3,{id:"freeze-authority",children:"Freeze Authority"}),"\n",(0,t.jsx)(n.p,{children:"Token-2022 tokens with freeze authority will be rejected unless TokenBadge account is initialized."}),"\n",(0,t.jsx)(n.p,{children:"If you initialise the pool with your Token-2022 tokens, make sure you have disabled FreezeAuthority."}),"\n",(0,t.jsx)(n.h3,{id:"native-token-wsol",children:"Native Token (WSOL)"}),"\n",(0,t.jsx)(n.p,{children:"Token-2022 program has its own Wrapped SOL mint address (9pan9bMn5HatX4EJdBwg9VgCa7Uz5HL8N1m5D3NdXejP). Let's call it WSOL-2022."}),"\n",(0,t.jsx)(n.p,{children:"Whirlpool program rejects WSOL-2022."}),"\n",(0,t.jsx)(n.p,{children:"WSOL-2022 has no token extensions, so please use original WSOL (So11111111111111111111111111111111111111112)."}),"\n",(0,t.jsx)(n.h3,{id:"transferfee",children:"TransferFee"}),"\n",(0,t.jsxs)(n.p,{children:["Anyone can initialize whirlpool with Token-2022 tokens having ",(0,t.jsx)(n.code,{children:"TransferFeeConfig"})," extension."]}),"\n",(0,t.jsxs)(n.h4,{id:"amount-and-otheramountthreshold",children:[(0,t.jsx)(n.code,{children:"amount"})," and ",(0,t.jsx)(n.code,{children:"otherAmountThreshold"})]}),"\n",(0,t.jsxs)(n.p,{children:["The relationship between ",(0,t.jsx)(n.code,{children:"amount"}),", ",(0,t.jsx)(n.code,{children:"otherAmountThreshold"})," and ",(0,t.jsx)(n.code,{children:"TransferFee"})," in each context."]}),"\n",(0,t.jsx)(n.p,{children:"The relationship between amount, otherAmountThreshold and TransferFee in each context."}),"\n",(0,t.jsxs)(n.p,{children:["ExactIn (",(0,t.jsx)(n.code,{children:"amount_specified_is_input = true"}),")"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"amount"}),": transfer fee Included amount (will be sent from user's token account)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"otherAmountThreshold"}),": transfer fee Excluded amount (will be received at user's token account)"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["ExactOut (",(0,t.jsx)(n.code,{children:"amount_specified_is_input = false"}),")"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"amount"}),": transfer fee Excluded amount (will be received at user's token account)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"otherAmountThreshold"}),": transfer fee Included amount (will be sent from user's token account)"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"The user can set conditions on the exact amount going out of and coming into the token account, regardless of fees."}),"\n",(0,t.jsx)(n.p,{children:"No additional parameters are added to limit the amount of fees. If the fee is changed, the new rate is delayed by two epochs to prevent sudden increases. In the edge case where a fee change is scheduled to take effect within the transaction\u2019s lifetime, transactions that exceed the outgoing and incoming amount thresholds will fail."}),"\n",(0,t.jsxs)(n.h4,{id:"minab-maxab",children:[(0,t.jsx)(n.code,{children:"minA/B"}),", ",(0,t.jsx)(n.code,{children:"maxA/B"})]}),"\n",(0,t.jsxs)(n.p,{children:["Increase Liquidity: ",(0,t.jsx)(n.code,{children:"maxA"}),", ",(0,t.jsx)(n.code,{children:"maxB"}),"\ntransfer fee Included amount (will be sent from user's token account)"]}),"\n",(0,t.jsxs)(n.p,{children:["Decrease Liquidity: ",(0,t.jsx)(n.code,{children:"minA"}),", ",(0,t.jsx)(n.code,{children:"minB"}),"\ntransfer fee Excluded amount (will be received at user's token account)"]}),"\n",(0,t.jsx)(n.h3,{id:"transferhook",children:"TransferHook"}),"\n",(0,t.jsx)(n.p,{children:"In order to use TransferHook, the owner of WhirlpoolsConfig must issue a TokenBadge for that token."}),"\n",(0,t.jsx)(n.h4,{id:"use-of-remaining_accounts",children:"Use of remaining_accounts"}),"\n",(0,t.jsxs)(n.p,{children:["The account used for TransferHook is different for each program used by TransferHook. Therefore, they are received through ",(0,t.jsx)(n.code,{children:"remaining_accounts"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["To clarify the context of accounts passed as ",(0,t.jsx)(n.code,{children:"remaining_accounts"}),", the v2 instructions receive ",(0,t.jsx)(n.code,{children:"remaining_accounts_info"})," as data. It is used to classify the accounts contained in ",(0,t.jsx)(n.code,{children:"remaining_accounts"}),". (e.g. The first 3 are for mintA's TransferHook, next 2 are for for mintB's TransferHook)."]}),"\n",(0,t.jsx)(n.h4,{id:"security-notes",children:"Security notes"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"In solana, indirect re-entrance will be rejected. So transfer hook program cannot call Whirlpool program."}),"\n",(0,t.jsx)(n.li,{children:"TransferHook program cannot modify transfer amount. It will be called AFTER token transfer processing."}),"\n",(0,t.jsx)(n.li,{children:"Token-2022 program remove signer and writable flag of the source, destination and owner when calling the TransferHook program even if they are passed as extra accounts. The source and destination are not updated and the owner's signature is not used unintentionally."}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"tokenbadge-request",children:"TokenBadge request"}),"\n",(0,t.jsx)(n.p,{children:"The TransferHook extension is a relatively new feature in the ecosystem, and its use cases are still being explored."}),"\n",(0,t.jsx)(n.p,{children:"While it\u2019s still undecided which types of TransferHook tokens will be eligible for a TokenBadge, the following best practices should guide selection:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"The code of the TransferHook program is publicly available."}),"\n",(0,t.jsx)(n.li,{children:"Verifiable Build has been done to ensure the code and program match."}),"\n",(0,t.jsx)(n.li,{children:"Upgrade authority have been disabled (ideal, but not required)"}),"\n",(0,t.jsx)(n.li,{children:"Only perform processes that pose no risk to the user (e.g. logging)"}),"\n",(0,t.jsx)(n.li,{children:"TransferHook must not block the transfer of tokens, or that the criteria for blocking are clearly declared, fair and reasonable."}),"\n",(0,t.jsx)(n.li,{children:"TransferHook must not interfere with the operation of the pool. It must not interfere with the trade, deposit, withdraw and harvest."}),"\n",(0,t.jsx)(n.li,{children:"Extensions that block transactions based on the amount of tokens to be transferred are undesirable because they cause transactions to fail in ways that are surprising to pool users. On the other hand, failing transfers to sanctioned wallets according to some public standard will not obstruct pool usage for many users."}),"\n",(0,t.jsx)(n.li,{children:"TransferHook must not request large numbers of accounts that would increase transaction size."}),"\n",(0,t.jsx)(n.li,{children:"TransferHook should not attempt any token transfers (including WSOL and native SOL)."}),"\n",(0,t.jsx)(n.li,{children:"TransferHook should not attempt imposing any kind of additional fees."}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}}}]);