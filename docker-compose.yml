name: whirlpools

services:

  yarn-install:
    image: node:22.8.0
    working_dir: /usr/src/whirlpools
    command: >
      sh -lc "corepack enable && corepack prepare yarn@4.6.0 --activate
      && yarn install"
    profiles: [build]
    volumes:
      - ./:/usr/src/whirlpools
      - node_modules:/usr/src/whirlpools/node_modules
      - yarn_cache:/usr/src/whirlpools/.yarn/cache

  build-solana-program:
    image: backpackapp/build:v0.29.0
    working_dir: /usr/src/whirlpools
    command: >
      anchor build
    profiles: [build]
    volumes:
      - ./:/usr/src/whirlpools

  # TS client is formatted using the @orca-so/whirlpools-lint package
  generate-clients:
    image: node:22.8.0
    working_dir: /usr/src/whirlpools
    command: >
      sh -lc "corepack enable && corepack prepare yarn@4.6.0 --activate
      && yarn workspace @orca-so/whirlpools-client generate
      && yarn workspace @orca-so/whirlpools-rust-client generate"
    profiles: [build]
    depends_on:
      yarn-install:
        condition: service_completed_successfully
    volumes:
      - ./:/usr/src/whirlpools
      - node_modules:/usr/src/whirlpools/node_modules:ro
      - yarn_cache:/usr/src/whirlpools/.yarn/cache:ro

  # TS SDK packages
  build-ts-tx-sender:
    image: node:22.8.0
    working_dir: /usr/src/whirlpools
    command: >
      sh -lc "corepack enable && corepack prepare yarn@4.6.0 --activate
      && yarn workspace @orca-so/tx-sender build"
    profiles: [build]
    volumes:
      - ./:/usr/src/whirlpools
      - node_modules:/usr/src/whirlpools/node_modules:ro
      - yarn_cache:/usr/src/whirlpools/.yarn/cache:ro
    depends_on:
      yarn-install:
        condition: service_completed_successfully

  build-ts-client:
    image: node:22.8.0
    working_dir: /usr/src/whirlpools
    command: >
      bash -lc "corepack enable && corepack prepare yarn@4.6.0 --activate
      && yarn workspace @orca-so/whirlpools-client build:fast"
    profiles: [build]
    depends_on:
      build-rust-core:
        condition: service_completed_successfully
      build-solana-program:
        condition: service_completed_successfully
      yarn-install:
        condition: service_completed_successfully
      generate-clients:
        condition: service_completed_successfully
    volumes:
      - ./:/usr/src/whirlpools
      - node_modules:/usr/src/whirlpools/node_modules:ro
      - yarn_cache:/usr/src/whirlpools/.yarn/cache:ro

  build-ts-core:
    image: rust:1.84.0
    working_dir: /usr/src/whirlpools
    command: >
      sh -c "curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
      && apt-get update && apt-get install -y nodejs
      && rustup target add wasm32-unknown-unknown
      && corepack enable && corepack prepare yarn@4.6.0 --activate
      && yarn workspace @orca-so/whirlpools-core build"
    profiles: [build]
    depends_on:
      build-rust-core:
        condition: service_completed_successfully
      build-ts-client:
        condition: service_completed_successfully
      yarn-install:
        condition: service_completed_successfully
    volumes:
      - ./:/usr/src/whirlpools
      - node_modules:/usr/src/whirlpools/node_modules
      - yarn_cache:/usr/src/whirlpools/.yarn/cache

  build-ts-whirlpool:
    image: node:22.8.0
    working_dir: /usr/src/whirlpools
    command: >
      sh -lc "corepack enable && corepack prepare yarn@4.6.0 --activate
      && yarn workspace @orca-so/whirlpools build"
    profiles: [build]
    depends_on:
      build-ts-tx-sender:
        condition: service_completed_successfully
      build-ts-client:
        condition: service_completed_successfully
      build-ts-core:
        condition: service_completed_successfully
      yarn-install:
        condition: service_completed_successfully
    volumes:
      - ./:/usr/src/whirlpools
      - node_modules:/usr/src/whirlpools/node_modules:ro
      - yarn_cache:/usr/src/whirlpools/.yarn/cache:ro

  build-ts-integration:
    image: node:22.8.0
    working_dir: /usr/src/whirlpools
    command: >
      sh -lc "corepack enable && corepack prepare yarn@4.6.0 --activate
      && yarn workspace @orca-so/whirlpools-integration build"
    profiles: [build]
    depends_on:
      build-ts-whirlpool:
        condition: service_completed_successfully
      yarn-install:
        condition: service_completed_successfully
    volumes:
      - ./:/usr/src/whirlpools
      - node_modules:/usr/src/whirlpools/node_modules:ro
      - yarn_cache:/usr/src/whirlpools/.yarn/cache:ro

  build-ts-lint:
    image: node:22.8.0
    working_dir: /usr/src/whirlpools
    command: >
      sh -lc "corepack enable && corepack prepare yarn@4.6.0 --activate
      && yarn workspace @orca-so/whirlpools-lint format"
    profiles: [build]
    depends_on:
      build-ts-whirlpool:
        condition: service_completed_successfully
      build-ts-client:
        condition: service_completed_successfully
      build-ts-core:
        condition: service_completed_successfully
      build-ts-tx-sender:
        condition: service_completed_successfully
      yarn-install:
        condition: service_completed_successfully
    volumes:
      - ./:/usr/src/whirlpools
      - node_modules:/usr/src/whirlpools/node_modules:ro
      - yarn_cache:/usr/src/whirlpools/.yarn/cache:ro

  # Legacy SDK packages
  build-legacy-common:
    image: node:22.8.0
    working_dir: /usr/src/whirlpools
    command: >
      sh -lc "corepack enable && corepack prepare yarn@4.6.0 --activate
      && yarn workspace @orca-so/common-sdk build"
    profiles: [build]
    volumes:
      - ./:/usr/src/whirlpools
      - node_modules:/usr/src/whirlpools/node_modules:ro
      - yarn_cache:/usr/src/whirlpools/.yarn/cache:ro
    depends_on:
      yarn-install:
        condition: service_completed_successfully

  build-legacy-whirlpool:
    image: node:22.8.0
    working_dir: /usr/src/whirlpools
    command: >
      sh -lc "corepack enable && corepack prepare yarn@4.6.0 --activate
      && yarn workspace @orca-so/whirlpools-sdk build"
    profiles: [build]
    depends_on:
      build-legacy-common:
        condition: service_completed_successfully
      build-solana-program:
        condition: service_completed_successfully
      yarn-install:
        condition: service_completed_successfully
    volumes:
      - ./:/usr/src/whirlpools
      - node_modules:/usr/src/whirlpools/node_modules:ro
      - yarn_cache:/usr/src/whirlpools/.yarn/cache:ro

  build-legacy-cli:
    image: node:22.8.0
    working_dir: /usr/src/whirlpools
    command: >
      sh -lc "corepack enable && corepack prepare yarn@4.6.0 --activate
      && yarn workspace @orca-so/whirlpools-sdk-cli build"
    profiles: [build]
    depends_on:
      build-legacy-common:
        condition: service_completed_successfully
      build-legacy-whirlpool:
        condition: service_completed_successfully
      yarn-install:
        condition: service_completed_successfully
    volumes:
      - ./:/usr/src/whirlpools
      - node_modules:/usr/src/whirlpools/node_modules:ro
      - yarn_cache:/usr/src/whirlpools/.yarn/cache:ro

  # Rust SDK packages
  build-rust-macros:
    image: rust:1.84.0
    working_dir: /usr/src/whirlpools/rust-sdk/macros
    command: >
      cargo build
    profiles: [build]
    volumes:
      - ./:/usr/src/whirlpools

  build-rust-core:
    image: rust:1.84.0
    working_dir: /usr/src/whirlpools/rust-sdk/core
    command: >
      cargo build
    profiles: [build]
    depends_on:
      build-rust-macros:
        condition: service_completed_successfully
    volumes:
      - ./:/usr/src/whirlpools

  build-rust-client:
    image: rust:1.84.0
    working_dir: /usr/src/whirlpools/rust-sdk/client
    command: >
      sh -c "rustup component add clippy rustfmt
      && cargo build
      && cargo clippy --fix --allow-dirty --allow-staged
      && cargo fmt"
    profiles: [build]
    depends_on:
      build-rust-core:
        condition: service_completed_successfully
      build-solana-program:
        condition: service_completed_successfully
      yarn-install:
        condition: service_completed_successfully
      generate-clients:
        condition: service_completed_successfully
    volumes:
      - ./:/usr/src/whirlpools
      - node_modules:/usr/src/whirlpools/node_modules:ro
      - yarn_cache:/usr/src/whirlpools/.yarn/cache:ro

  build-rust-tx-sender:
    image: rust:1.84.0
    working_dir: /usr/src/whirlpools/rust-sdk/tx-sender
    command: >
      cargo build
    profiles: [build]
    volumes:
      - ./:/usr/src/whirlpools

  build-rust-whirlpool:
    image: rust:1.84.0
    working_dir: /usr/src/whirlpools/rust-sdk/whirlpool
    command: >
      cargo build
    profiles: [build]
    depends_on:
      build-rust-core:
        condition: service_completed_successfully
      build-rust-client:
        condition: service_completed_successfully
    volumes:
      - ./:/usr/src/whirlpools

  build-rust-integration:
    image: node:22.8.0
    working_dir: /usr/src/whirlpools
    command: >
      sh -lc "corepack enable && corepack prepare yarn@4.6.0 --activate
      && yarn workspace @orca-so/whirlpools-rust-integration build"
    profiles: [build]
    depends_on:
      build-rust-whirlpool:
        condition: service_completed_successfully
      build-rust-client:
        condition: service_completed_successfully
      build-rust-core:
        condition: service_completed_successfully
      yarn-install:
        condition: service_completed_successfully
    volumes:
      - ./:/usr/src/whirlpools
      - node_modules:/usr/src/whirlpools/node_modules:ro
      - yarn_cache:/usr/src/whirlpools/.yarn/cache:ro

  # Docs packages
  build-docs-ts:
    image: node:22.8.0
    working_dir: /usr/src/whirlpools
    command: >
      sh -lc "corepack enable && corepack prepare yarn@4.6.0 --activate
      && yarn workspace @orca-so/whirlpools-docs-ts build"
    profiles: [build]
    depends_on:
      build-ts-whirlpool:
        condition: service_completed_successfully
      build-ts-client:
        condition: service_completed_successfully
      build-ts-core:
        condition: service_completed_successfully
      yarn-install:
        condition: service_completed_successfully
    volumes:
      - ./:/usr/src/whirlpools
      - node_modules:/usr/src/whirlpools/node_modules:ro
      - yarn_cache:/usr/src/whirlpools/.yarn/cache:ro

  build-docs-rust:
    image: rust:1.84.0
    working_dir: /usr/src/whirlpools/docs/rust
    command: >
      cargo doc --lib --no-deps && cp -rf target/doc/. dist
    profiles: [build]
    depends_on:
      build-rust-whirlpool:
        condition: service_completed_successfully
      build-rust-client:
        condition: service_completed_successfully
      build-rust-core:
        condition: service_completed_successfully
    volumes:
      - ./:/usr/src/whirlpools

  build-docs-legacy:
    image: node:22.8.0
    working_dir: /usr/src/whirlpools
    command: >
      sh -lc "corepack enable && corepack prepare yarn@4.6.0 --activate
      && yarn workspace @orca-so/whirlpools-docs-legacy build"
    profiles: [build]
    depends_on:
      build-legacy-common:
        condition: service_completed_successfully
      build-legacy-whirlpool:
        condition: service_completed_successfully
      yarn-install:
        condition: service_completed_successfully
    volumes:
      - ./:/usr/src/whirlpools
      - node_modules:/usr/src/whirlpools/node_modules:ro
      - yarn_cache:/usr/src/whirlpools/.yarn/cache:ro

  build-docs:
    image: node:22.8.0
    working_dir: /usr/src/whirlpools
    command: >
      sh -lc "corepack enable && corepack prepare yarn@4.6.0 --activate
      && yarn workspace @orca-so/whirlpools-docs build"
    profiles: [build]
    depends_on:
      build-docs-ts:
        condition: service_completed_successfully
      build-docs-rust:
        condition: service_completed_successfully
      build-docs-legacy:
        condition: service_completed_successfully
      yarn-install:
        condition: service_completed_successfully
    volumes:
      - ./:/usr/src/whirlpools
      - node_modules:/usr/src/whirlpools/node_modules:ro
      - yarn_cache:/usr/src/whirlpools/.yarn/cache:ro

  # Example apps
  build-example-ts-next:
    image: node:22.8.0
    working_dir: /usr/src/whirlpools
    command: >
      sh -lc "corepack enable && corepack prepare yarn@4.6.0 --activate
      && yarn workspace @orca-so/whirlpools-example-ts-next build"
    profiles: [build]
    depends_on:
      build-ts-whirlpool:
        condition: service_completed_successfully
      yarn-install:
        condition: service_completed_successfully
    volumes:
      - ./:/usr/src/whirlpools
      - node_modules:/usr/src/whirlpools/node_modules:ro
      - yarn_cache:/usr/src/whirlpools/.yarn/cache:ro

  build-example-rust-bot:
    image: rust:1.84.0
    working_dir: /usr/src/whirlpools/examples/rust-sdk/whirlpool_repositioning_bot
    command: >
      cargo build
    profiles: [build]
    depends_on:
      build-rust-whirlpool:
        condition: service_completed_successfully
      build-rust-client:
        condition: service_completed_successfully
      build-rust-core:
        condition: service_completed_successfully
    volumes:
      - ./:/usr/src/whirlpools

  build:
    image: alpine:3
    working_dir: /usr/src/whirlpools
    command: >
      echo "Build Completed"
    depends_on:
      build-solana-program:
        condition: service_completed_successfully
      build-ts-tx-sender:
        condition: service_completed_successfully
      build-ts-client:
        condition: service_completed_successfully
      build-ts-core:
        condition: service_completed_successfully
      build-ts-whirlpool:
        condition: service_completed_successfully
      build-ts-integration:
        condition: service_completed_successfully
      build-legacy-common:
        condition: service_completed_successfully
      build-legacy-whirlpool:
        condition: service_completed_successfully
      build-legacy-cli:
        condition: service_completed_successfully
      build-rust-macros:
        condition: service_completed_successfully
      build-rust-core:
        condition: service_completed_successfully
      build-rust-client:
        condition: service_completed_successfully
      build-rust-tx-sender:
        condition: service_completed_successfully
      build-rust-whirlpool:
        condition: service_completed_successfully
      build-rust-integration:
        condition: service_completed_successfully
      build-ts-lint:
        condition: service_completed_successfully
      build-docs-ts:
        condition: service_completed_successfully
      build-docs-rust:
        condition: service_completed_successfully
      build-docs-legacy:
        condition: service_completed_successfully
      build-docs:
        condition: service_completed_successfully
      build-example-ts-next:
        condition: service_completed_successfully
      build-example-rust-bot:
        condition: service_completed_successfully
    profiles: [build]
    volumes:
      - ./:/usr/src/whirlpools

volumes:
  node_modules:
  yarn_cache:
